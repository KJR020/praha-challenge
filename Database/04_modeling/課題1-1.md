# データモデリング2 課題1-1

リマインダーアプリのDB設計

## 1. データモデル


> API側でhttps://slack.com/api/oauth.v2.accessに対して、先ほど取得したcode,clientId,clientSecretなどを含めて送信します。
  

```mermaid
classDiagram

  namespace リソース {
    class スラックユーザー {
      int id
      varchar slack_id
      varchar slack_workspace_id
    }
    class リマインドする人
    class リマインドされる人

    class slackワークスペース {
      int id
      varchar workspace_id
      varchar access_token
    }

    class slackチャンネル {
      int id
      varchar channel_id
      varchar channel_name
      varchar workspace_id
    }

    class タスク {
      int id
      text content
      int created_by
      boolean is_completed
    }
    class 日周期タスク {
      int 日周期
    }
    class 曜日タスク {
      int 曜日周期
    }
    class 月周期タスク {
      int 月周期
    }
  }
  
  namespace イベント {
    class タスクイベント
    class タスク作成
    class タスク削除
    class タスク完了
    class リマインド {
      int id
      int task_id
      int remind_target_id
      int remind_channel_id
      timestamp remind_at
    }
  }

  ユーザー <|-- リマインドする人
  ユーザー <|-- リマインドされる人

  タスク <|-- 日周期タスク
  タスク <|-- 曜日タスク
  タスク <|-- 月周期タスク

  タスクイベント <|-- タスク作成
  タスクイベント <|-- タスク削除
  タスクイベント <|-- タスク完了
```

- 複数ユーザーに通知を出せる
- タスクの完了状態はユーザーごと管理とする
  - 誰かが完了したらOKというタスクは設定しない

```mermaid
sequenceDiagram
  autonumber
  actor reminder as リマインド設定者 
  participant slack as Slack
  participant api as バックエンドAPI
  participant db as データベース
  participant task as タスクキュー
  participant batch as バッチ
  actor remind_target as リマインドされる人
  
  %% タスク作成
  reminder ->> slack: スラッシュコマンド(/penpen)
  slack ->> api: コマンドリクエスト
  api ->> db: タスク情報を保存
  api ->> task: タスク作成
  
  %% リマインドフロー
  loop every 1hour 
    batch ->> task: バッチでタスク確認
    batch ->> db: リマインド対象のワークスペース情報取得
    Note right of batch: accessTokenを取得
    batch ->> slack: リマインドメッセージ送信(accessToken利用)
    slack ->> remind_target: リマインド表示
    batch ->> db: 送信済みメッセージ情報保存(channel_id, message_ts)
  end
  
  %% タスク完了/解除フロー
  alt タスク完了
    remind_target ->> slack: タスク完了ボタンクリック
    slack ->> api: アクションリクエスト
    api ->> db: ワークスペース情報取得(accessToken)
    api ->> db: 送信済みメッセージ情報取得(channel_id, message_ts)
    api ->> slack: メッセージ更新(accessToken, channel_id, message_ts利用)
    api ->> db: タスク完了状態を更新
    api ->> slack: タスク完了通知(accessToken利用)
    slack ->> reminder: タスク完了通知
  else タスク解除
    reminder ->> slack: タスク解除コマンド
    slack ->> api: 解除リクエスト
    api ->> db: ワークスペース情報取得(accessToken)
    api ->> db: 送信済みメッセージ情報取得(channel_id, message_ts)
    api ->> slack: メッセージ更新/削除(accessToken, channel_id, message_ts利用)
    api ->> task: タスク解除
  end
```


## 2. ER図

```mermaid
erDiagram
  users {
    serial id PK
    varchar username
    varchar slack_id
  }
  
  slack_workspaces {
    serial id PK
    varchar team_id
    varchar team_name
    varchar access_token
    timestamp created_at
  }
  
  user_workspaces {
    serial id PK
    int user_id FK
    int workspace_id FK
  }
  
  tasks {
    int id PK
    text content
    int created_by FK
    timestamp created_at
  }
  
  remind_targets {
    int id PK
    int task_id FK
    int user_id FK
    boolean is_completed
    timestamp completed_at
  }
  
  remind_cycles {
    int id PK
    int task_id FK
    varchar cycle_type
    int interval_value
  }
  
  sent_reminders {
    int id PK
    int task_id FK
    int target_user_id FK
    varchar channel_id
    varchar message_ts
    timestamp sent_at
  }
  
  task_events {
    int id PK
    int task_id FK
    varchar event_type
    timestamp created_at
  }
  
  users ||--|{ tasks : "タスク設定する"
  users ||--o{ user_workspaces : "所属する"
  user_workspaces }o--|| slack_workspaces : "ワークスペース"
  tasks ||--o| remind_cycles : "リマインド周期設定"
  tasks ||--o{ task_events : "タスクイベント"
  tasks ||--o{ remind_targets : "リマインド対象"
  tasks ||--o{ sent_reminders : "送信履歴"
  remind_targets ||--o{ sent_reminders : "送信対象"
```

## 3. DDL

- [DDL.sql](src/1-DDL.sql)

## 4. DML

- [DML.sql](src/2-DML.sql)

## 5. クエリサンプル

- [queries.sql](src/3-queries.sql)
