# 課題1-1

## 課題内容

MySQLやPostgreSQLには「Check」「Enum」「Domain」「Trigger」など、システムの仕様をデータベースに強制するために様々な機能が用意されています。

以下のケースを読みながら、どのような状況で上記機能を使うべきか、どのような状況で使うべきではないか、考えてみてください！

本サービスには「User」というテーブルが用意されていると仮定します

- 「mailAddress」カラムには、特定のドメインを持ったメールアドレスしか登録できない（a@example.com, b@example.comなど）。Checkを使うべきでしょうか？
- ユーザーが退会した時、当該ユーザーのレコードを「User」テーブルから削除し、同じ情報を「WithdrawnUser」テーブルに挿入しなければいけない。Triggerを使うべきでしょうか？
- 「gender」カラムには「male」「female」「no response」いずれかの値しか入れてはいけない。Enumを使うべきでしょうか？
- 「postCode」カラムには特定形式の文字列しか入れてはいけない。Domainを使うべきでしょうか？

上記のような制約をアプリケーション側で課すアプローチと、データベース側で制約を課すアプローチがあります。どちらをどのような時に採用するべきだと思いますか？

## 回答

### 1. Check制約

> 「mailAddress」カラムには、特定のドメインを持ったメールアドレスしか登録できない（a@example.com, b@example.comなど）。Checkを使うべきでしょうか？

- Checkを使うべきではない
- 理由は下記
  - メールアドレスのドメイン制約は、ビジネスルールに依存する可能性が高く、将来的に変更される可能性がある
  - アプリケーション層から見た時に、制約が見えづらく、保守性が低下する

### 2. Trigger

> ユーザーが退会した時、当該ユーザーのレコードを「User」テーブルから削除し、同じ情報を「WithdrawnUser」テーブルに挿入しなければいけない。Triggerを使うべきでしょうか？ 

- Triggerを使うべきではない
- 理由は下記
  - ビジネスロジック（退会処理）をデータベース層に埋め込むことになり、アプリケーションの透明性が低下する
  - アプリケーション層から見た時に、制約が見えづらく、保守性が低下する
  - トランザクション管理が複雑になる
    - 退会時に、データ移行以外の処理（関連レコードの更新など）が必要な場合、それらとトリガー処理の関連づけが不透明になる

### 3. Enum

> 「gender」カラムには「male」「female」「no response」いずれかの値しか入れてはいけない。Enumを使うべきでしょうか？


- 基本的には使うべきでないと考える

- データベースレベルでの制約により、不正な値の挿入を防止できる
- 将来的に選択肢が増える可能性がある場合、スキーマ変更が必要になる
- RDBMSによってEnum型の実装や移行のサポートが異なる

- ORMを使用しない or Enumをサポートされていない場合は、値の選択肢が変わらないものであれば有効そう


### 4. Domain

> 「postCode」カラムには特定形式の文字列しか入れてはいけない。Domainを使うべきでしょうか？

- 以下の理由から、基本的には使うべきでないと考える
- 制約がアプリケーション層から見えず、保守性が低下する

- ORMでサポートされていないケースが多い
  - ORMでDomainをサポートしDB層の制約と同期することが可能であれば、使うことも選択肢として良さそう
    - 郵便番号の形式は基本的には変わらないため、スキーマ変更が生じるリスクも低い
