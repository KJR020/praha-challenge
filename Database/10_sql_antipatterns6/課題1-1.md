# 課題1-1

## 課題内容

以下のようなテーブルが定義されていたとしましょう。
生徒を管理するテーブルで、「在学中」「卒業」「停学中」などのステータスが存在します。

```sql
TABLE Student {
  id: varchar
  name: varchar
  status: varchar CHECK(status IN ("studying", "graduated", "suspended"))
}
```

`status`カラムには「studying」「graduated」「suspended」いずれかの値しか入らないようにcheck機能を使っています。

上記の設計だとどのような問題が生じるか、説明してください。

## 回答

- この設計は、SQL Antipatternsで`31 Flavors`と呼ばれるアンチパターンに該当する
  - 取りうる値の集合をスキーマ定義内に直接埋め込む手法

- 問題点は以下の通り

1. メタデータのクエリ困難性
- 許容値の集合を取得するには、システムテーブルからメタデータを抽出する必要がある
  - 許容値を取り出す場合に、カラム定義の文字列からパースするなど複雑になりやすい
  - アプリケーションで別途リスト管理する場合も、整合性維持が複雑になる
2. 許容値の追加/削除にDBスキーマの変更が必要
- 新しいステータス値を追加/削除する場合、データベースのスキーマ変更が必要
- 履歴データの整合性問題
  - 許容値を削除する場合、既存レコードとの整合性維持が複雑になる
  - 特に履歴データを維持する場合、履歴データでCHECK制約を緩和する必要がのこる
    - 新しく設定するステータス値に対してバリデーションをする場合
    - アプリケーション層で制御する必要が生じ、二重管理が発生する
3. 移植性の問題
- 移植先のRDBMSによっては、DDLの構文の非互換性がある
- 移植時に再実装が必要になる
