# マルチテナント

## 課題1-1

「妥当SmartHR!」を旗印に生まれたスタートアップ「IntelligentHR」のエンジニアであるあなたは、テナント（企業など）毎のデータを取得する際は以下のようなクエリを発行するようなアプリケーションを作成しました。

```sql
SELECT * FROM employees WHERE tenant_id = 'praha';
```

「パクリすぎじゃない？」という市場の声を押しのけて資金調達に成功したIntelligentHRは採用を強化し、新たに3名の新人エンジニアが入社しました。
しかし開発現場は大忙し。コードレビューもロクにできず、新人の1人が新機能を開発する際、うっかりとテナントを指定し忘れて、こんなクエリを発行するコードを本番環境にデプロイしてしまいました。

```sql
SELECT * FROM employees; <- WHERE tenant_id = 'praha'を指定し忘れている！
```

ある日、株式会社HogeHogeの社長がIntelligentHRを使っていると、そのサービスに登録しているすべての会社の全従業員データが表示されていることに気づき、大変な騒ぎになりました。結果IntelligentHRは多額の賠償金を請求されて事業停止に追い込まれてしまいました...

タイムマシンを使って過去に戻れるとしたら、このようなミスが起きないよう、どんな対策を施しますか？

## 回答

- 1~4のような方法で、テナントごとにデータを分離する
  - 個人的には4. RLSで分離する方法がコストと安全性のバランスが良いと感じる

### 1. DBレベルでの分離

- テナントごとにデータベースを作成する方法
- メリット
  - 安全性としては1~4の選択肢の中で一番高い
  - 共通データは専用APIサービス化または各DBへのレプリケーションで対応する必要がある
- デメリットとしてインフラコストが高くなり、運用負荷が高い方法になる
  - マイグレーションコスト
  - アプリからのDB接続
  - テナント追加時にデータベース初期化が必要になる
  - テナントとDBの紐付け管理が別途必要になる
- 共有データ/テナント専用のDBを分ける手法もある
  - https://speakerdeck.com/yaggy/tenantofen-li-shi-noshi-ifen-ketobaransu-saas-engineering-meetup-kitukuohuibento?slide=12

### 2. スキーマレベルでの分離

- テナントごとにスキーマを作成する方法
- メリット
  - 1よりは安全性は低いが、テナントごとにスキーマを分けることで、誤って他のテナントのデータにアクセスするリスクを減らすことができる。
  - DBレベルでの分離と比べると、インフラコストが低くや共通データの扱いもしやすい
- デメリット
  - マイグレーションコスト
  - アプリからのDB接続
  - テナント追加時にデータベース初期化が必要になる
  - テナントとスキーマの紐付け管理が別途必要になる

### 3. テーブルレベルでの分離

- テナントごとにテーブルを作成する方法
- 1つのデータベースないでテナントのデータを保存できる
- メリット
  - スキーマレベルでの分離よりは安全性が低いが、テナントごとにテーブルを分けることで、誤って他のテナントのデータにアクセスするリスクを減らすことができる。
  - DBレベルでの分離と比べると、インフラコストが低くや共通データの扱いもしやすい
- デメリット
  - マイグレーションコスト
  - テナント追加時にテーブル初期化が必要になる
  - テナントのテーブルで外部キーが複雑になる

1. レコードレベルでの分離

- RLS（Row Level Security）などを使用して、テナントごとにデータのアクセス制御を行う。
  - 以下のような方法でも対策が可能
    - ORMで自動でWHERE区を付与する
    - APIのバリデーションでテナントIDをチェックする
    - テストでチェックする
- RLSを設定することで、クエリが実行される際に自動的にテナントIDがフィルタリングされ、誤って全データにアクセスすることを防ぐ。
- メリット
  - マイグレーションコストが低い
  - データベース側の設定コストが低い
- デメリット
  - 同一テーブル上にデータが存在するため、ほか方法と比べると分離の安全性は低い
  - データベースユーザーのセッション管理がネックになる

## 参考

- https://qiita.com/nassy20/items/99ff3d7ac0fb00989aef
